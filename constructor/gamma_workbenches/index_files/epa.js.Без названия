$(function() {
	var epaZone = $('#epazone');
	if (!epaZone.length) return;
	/**
	 * dependencies
	 */
	//var tpl = window.tpl;
	var Mustache = window.Mustache;

	/**
	 * dom elements
	 */
	var areas = epaZone.children();
	var numberCont = $('.number');
	var numbers = numberCont.children();

	var set = numbers.add(areas);

	var template = $(tpl).filter('#epa_hint').html();
	Mustache.parse(template);

	/**
	 * Current number and hint
	 */
	var hint;
	var number;

	set.each(function() {
		$(this).attr('data-filter', $(this).attr('class'));
	});

	var removeHint = function() {
		number && number.removeClass('active');
		hint && hint.remove();
		number = hint = undefined;
	};

	var showHint = function(id) {
		if (number && (number.data('filter') == id)) {
			return;
		}

		removeHint();

		var filter = '[data-filter="' + id + '"]';
		number = numbers.filter(filter);
		var area = areas.filter(filter);

		var html = Mustache.render(template, {
			title:    area.attr('title'),
			descr:    area.attr('alt'),
			position: number.data('position')
		});
		hint = $(html);
		number.append(hint).addClass('active');
	};

	set.mouseenter(function onMouseEnter(e) {
		var target = $(this);
		if (!target.data('filter')) {
			target = target.parents(':([data-filter])');
		}

		var id = target.data('filter');
		showHint(id);
	});

	set.mouseleave(function onMouseLeave(e) {
		var to = $(e.relatedTarget);
		if (to.is(hint)
			|| to.is(set)
			|| to.is('hr')
		) {
			return;
		}
		removeHint();
	});
});