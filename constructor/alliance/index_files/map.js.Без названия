$.fn.point = function(dataMap) {
    'use strict';

    var data = dataMap;
    var gCollection = new ymaps.GeoObjectArray();
    var tmp = 0;
    var id = '';
    var myMap;
    var init = function () {
            myMap = new ymaps.Map('map', {
                center: [59.938531, 30.313497],
                zoom: 8
            });
            myMap.controls.add('zoomControl', {left: 5, top: 5});
            draw(data);
            markerShowById($('[data-city-id="' + $('#city').val() + '"] select').val());
            //marker(data, 145);
        },
        draw = function (data) {
            var obj = data;

            gCollection.removeAll();

            var j = 0;
            for (var i in obj) {
                var placemark = new ymaps.Placemark([obj[i].map[0], obj[i].map[1]], {
                    id: i,
                    colId: j
                }, {
                    // Опции.
                    // Своё изображение иконки метки.
                    iconImageHref: '/i/marker.png',
                    // Размеры метки.
                    iconImageSize: [16, 16],
                    // Смещение левого верхнего угла иконки о тносительно
                    // её "ножки" (точки привязки).
                    iconImageOffset: [-3, -8]
                });
                gCollection.add(placemark);
                j++;
            }
            myMap.geoObjects.add(gCollection);

            gCollection.events.add('click', function (e) {
                var id = e.get('target').properties.get('colId');
                markerShowByColId(id);
            });

            setCenter();
        },
        setCenter = function () {
            var index = $('[data-city-id="' + $('#city').val() + '"] select').val();
            myMap.setCenter([dataMap[index].map[0], dataMap[index].map[1]], 10);
        },
        markerShowByColId = function (id) {
            gCollection.each(function (e) {
                e.options.set({iconImageHref: '/i/marker.png'});
            });

            var m = gCollection.get(id);

            m.options.set({iconImageHref: '/i/marker-active.png'});

            $('.partnerChoice .js-dealers').find('option[value="' + m.properties.get('id') + '"]').prop('selected', true);
            $('[data-city-id="' + $('#city').val() + '"] select').trigger("chosen:updated");
            showDealer();
        },
        markerShowById = function (id) {
            var m = null;
            gCollection.each(function (e) {
                e.options.set({iconImageHref: '/i/marker.png'});
                if(e.properties.get('id') == id)
                {
                    m = e;
                }
            });

            m.options.set({iconImageHref: '/i/marker-active.png'});
        };
	init();

    $('#map').on('setCenter', function(){
        setCenter();
    });

    $('#map').on('setMarker', function(){
        markerShowById($('[data-city-id="' + $('#city').val() + '"] select').val());
    });

	//var obj = data;
	/*$('.partnerChoice select').change(function(){
		var el = $(this),
			type = el.attr('id'),
			val = el.val();
		if(type === 'city'){
			$.post('', 'cityId='+val, function(data){
				obj = data;
				var tpl_dealer,
					render = function() {
						var content = $(Mustache.render(tpl_dealer, obj));
						$('#dealers').html(content);
						$('#dealers').trigger("chosen:updated").trigger('change');
						draw(obj);
						marker(obj, 0);
						$('#dealers option').prop('selected', false);
						$('#dealers option').eq(0).prop('selected', true);
						$('#dealers').trigger("chosen:updated");
					};
				tpl_dealer = $(tpl).filter('#dealer_tpl').html();
				render();
			}, 'json');
		} else {
			var id = el.find('option:selected').index();
			marker(obj, id);
		}
	});*/
};
